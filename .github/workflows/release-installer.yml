name: Build installer on Release

on:
  release:
    types: [published]

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore development-kits.csproj

      - name: Publish self-contained single-file (win-x64)
        run: |
          dotnet publish development-kits.csproj -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=false -o publish\win-x64

      - name: Install Inno Setup (choco)
        run: choco install innosetup -y

      - name: Create Inno Setup script
        run: |
          cat > installer.iss << 'ISS'
          [Setup]
          AppName=development-kits
          AppVersion=${{ github.event.release.tag_name }}
          DefaultDirName={pf}\development-kits
          OutputDir=installer
          OutputBaseFilename=development-kits-setup-${{ github.event.release.tag_name }}
          Compression=lzma
          SolidCompression=yes

          [Files]
          ; include all published files
          Source: "publish\\win-x64\\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\development-kits"; Filename: "{app}\\development-kits.exe"
          ISS

      - name: Build installer (Inno Setup)
        env:
          PATH: ${{ env.PATH }}
        run: |
          echo "Running Inno Setup Compiler to build installer..."
          iscc installer.iss

      - name: Upload installer to release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: installer/development-kits-setup-${{ github.event.release.tag_name }}.exe
          asset_name: development-kits-setup-${{ github.event.release.tag_name }}.exe
          asset_content_type: application/octet-stream
